Разбор работы антивируса ClamAV
Clam AntiVirus - пакет антивирусного ПО, работающий во многих операционных системах, включая Unix-подобные ОС, OpenVMS, Microsoft Windows и Apple Mac OS X.
Выпускается под GNU General Public License и является свободным программным обеспечением.
Главная цель Clam AntiVirus - интеграция с серверами электронной почты для проверки файлов, прикрепленных к сообщениям. В пакет входит масштабируемый многопоточный демон clamd, управляемый из командной строки сканер clamscan, а также модуль обновления сигнатур по Интернету freshclam.[9]
Хоть основная функция ClamAV - это проверка файлов прикрепленных к почтовым сообщениям, он также может сканировать и систему в целом, как в ручном так и в автоматическом режиме, все зависит от конфигураций. 
Почему же я выбрал для разбора такой малоизвестный антивирус как ClamAV? Все очень просто, по моему мнению это весьма недооцененный продукт который находится в открытом доступе, хоть и принадлежит компании Cisco Systems. Главным недостатком данного продукта является его медлительность при сканировании системы, это обусловлено тем, что каждый проверяемый файл полностью читается и проверяется по всем базам данных вирусных сигнатур, что является его преимуществом, так как далеко не все антивирусы читают файл полностью проводя лишь “поверхностное” сканирование, данный недостаток нивелируется при сканировании почтового трафика на шлюзах.
У меня уже был заранее установлен данный продукт на виртуальной машине под управлением ОС Linux Debian 10, также в дополнение к самому ClamAV можно установить ClamTK, который просто является визуальной оболочкой для ClamAV, чтобы не использовать его через консоль, я этого не делал, так как весь функционал раскрывается непосредственно при использовании консольной версии. Так как для своих целей я использовал ClamAV в качестве антивируса, а не сканера почтового трафика на шлюзах, то соответственно продемонстрирую работу данного антивируса в качестве сканера системы.
Стоит немного оговориться, хоть ClamAV и является открытым продуктом, но он все же принадлежит Cisco Systems, из-за чего могут быть проблемы с обновлением баз данных.
Установка и первоначальная настройка ClamAV для Linux максимально проста. [10]
Первым делом обновляем систему: apt-get update
После чего устанавливаем сам антивирус и демона для того чтобы ClamAV смог взаимодействовать с файлами: apt-get install clamav clamav-daemon
После чего переходим в папку с конфигами при помощи команды: open /usr/local/etc/
Видим два файла clamd.conf.sample и freshclam.conf.sample, стираем в названии обоих “.sample”, открываем каждый конфиг удаляем вверху слово “Example”, и вставляем строку “DatabaseDirectory /var/lib/clamav”, тут указан путь к базам данных в которых содержатся вирусные сигнатуры (данные базы обновляются автоматически при помощи сервиса clamav-freshclam), для автоматического обновления баз данных необходимо еще в файле freshclam.conf изменить строку “ScriptedUpdates yes”, на “ScriptedUpdates no” и под ней написать “PrivateMirror clmvupd.deltamoby.ru”, это зеркало с базами вирусных сигнатур для ClamAV, доступ к которым имеют все.
Все после этого мы можем работать с ClamAV, хотя лично я не делал автоматического обновления баз данных, но это не проблема, так как все эти манипуляции и действия делались исключительно в учебных целях.
Для сканирования системы первым делом необходимо запустить антивирус делается это командой: sudo service clamav-daemon start, после чего проверяем запустился ли антивирус командой sudo service clamav-daemon status.

Рис.3 Запуск и проверка статуса антивируса ClamAV.
Теперь нам необходимо что-то просканировать, но для начала давайте создадим файл с вирусной сигнатурой в нашей системе, для этого я использую известный тестовыйы файл elicar. После того как мы создали то, что необходимо будет найти нам нужно понять, а как искать. Для этого все также используется консоль в которую прописывается clamscan опции /путь к файлу/, перечень опций не столь обширен [11]:
-V, --version - вывести версию программы;
-v, --verbose - максимально подробный вывод;
-a, --archive-verbose - выводить сообщения о проверяемых файлах внутри архивов;
--debug - отображать отладочные сообщения;
--quiet - выводить минимум информации;
--no-summary - не отображать результат сканирования;
-i, --infected - выводить информацию только об инфицированных файлах;
--bell - воспроизводить звуковой сигнал при обнаружении вируса;
-d, --database - загрузить вирусную базу данных из файла;
-l, --log - сохранить результат сканирования в файл;
-r, --recursive - рекурсивное сканирование директорий и поддиректорий;
--move - перемещать инфицированные файлы в указанную папку;
--copy - копировать инфицированные файлы в указанную папку;
--exclude, --exclude-dir - не сканировать файлы и папки, имена которых подпадают под шаблон;
--remove - удалять все инфицированные файлы;
--scan-pe=yes/no - сканировать исполняемые файлы Windows, по умолчанию включено;
--scan-elf=yes/no - сканировать исполняемые файлы Linux, по умолчанию включено;
--scan-ole2=yes/no - сканировать документы Office, по умолчанию включено;
--scan-archive=yes/no - сканировать архивы, по умолчанию включено;
--max-filesize - максимальный размер данных, извлекаемых из архива, по умолчанию 25 Мб;
--max-files - извлекать не больше указанного количества файлов из сканируемых файлов (архивы, документы, любой вид контейнеров), по умолчанию 10000;
--max-recursion - максимальная глубина сканирования папок в архиве, по умолчанию 16;
--max-dir-recursion - максимальная глубина сканирования папок в файловой системе, по умолчанию 15.
К сожалению по непонятной причине рекурсивное сканирование директорий и поддиректорий при использовании в конце сканирования выдает ошибку, поэтому в своих целях я использовал хитрость, использовал вместо пути к файлу или папке функцию  --file-list=/путь к файлу/, в котором содержаться все пути для сканирования, это делается например если вы хотите сканировать папки “Загрузки”, “Документы” и “Рабочий стол” за одно сканирование. 
Я создал .txt файл под названием “list” в папке “Документы”, в данном файле я записал четыре путя к 4 папкам, а именно:
/home/kal/Загрузки
/home/kal/Загрузки/pipe
/home/kal/Загрузки/postgresql
/home/kal/Загрузки/postgresql/alla
И поместил в эти папки как файлы с вирусными сигнатурами, так и без.

Рис.4 Демонстрация “домашней” директории и файла с записанными директориями сканирования.
Хорошо мы теперь полностью готовы к работе, я хочу чтобы ClamAV, выводил данные только при обнаружении файлов с вирусными сигнатурами, в определенных директориях записанных в файле “list.txt”, находящимся “/home/kal/Документы/”, после чего сохранял отчет о сканировании в файл под названием “scan.log”, для этого нам необходимо сформировать команду, которая будет иметь следующий вид: 
clamscan -i --file-list=/home/kal/Документы/list.txt -l scan.log / &
Здесь, “/ &” используется для удобства, чтобы выполнение команды происходило в фоновом режиме.


Рис.5 Промежуточный результат работы команды.
У меня при запуске вывелось предупреждение о том что базам моих сигнатур более 7 дней, это не страшно, также тут есть предупреждение о том что при использовании “file-list” подкатегорий (папка в папке) производиться не будет, на что мы также согласны. Теперь ждем завершения сканирования.

Рис.6 Завершение сканирования ClamAV.

Рис.7 Демонстрация нахождения файла “scan.log” и его содержимого.
Видим что в домашней директории был создан файл “scan.log”, его содержимое совпадает с тем, что выводилось на терминале, а именно:
”-------------------------------------------------------------------------------

WARNING: Only scanning files from --file-list (files passed at cmdline are ignored)
/home/kal/Загрузки/eicar_com.zip: Win.Test.EICAR_HDB-1 FOUND
/home/kal/Загрузки/eicar.com: Win.Test.EICAR_HDB-1 FOUND
/home/kal/Загрузки/pipe/non_virus.com: Win.Test.EICAR_HDB-1 FOUND
/home/kal/Загрузки/pipe/mb_virus.zip: Win.Test.EICAR_HDB-1 FOUND
/home/kal/Загрузки/postgresql/molly: Win.Test.EICAR_HDB-1 FOUND
/home/kal/Загрузки/postgresql/cian: Win.Test.EICAR_HDB-1 FOUND
/home/kal/Загрузки/postgresql/alla/misa.zip: Win.Test.EICAR_HDB-1 FOUND
/home/kal/Загрузки/postgresql/alla/inaros.com: Win.Test.EICAR_HDB-1 FOUND
----------- SCAN SUMMARY -----------
Known viruses: 8615055
Engine version: 0.104.2
Scanned directories: 4
Scanned files: 13
Infected files: 8
Data scanned: 38.55 MB
Data read: 81.73 MB (ratio 0.47:1)
Time: 139.733 sec (2 m 19 s)
Start Date: 2022:05:13 22:01:10
End Date:   2022:05:13 22:03:30 ”
Также давайте немного разберем базы данных вирусных сигнатур, которые использует ClamAV. Базы данных хранятся в директории указанных в конфигурационном файле, а именно “/var/lib/clamav”, всего есть три файла 	“bytecode.cvd”, “daily.cvd”, “main.cvd”. “bytecode.cvd” - содержит оперативные изменения, а именно дополнительные методы обнаружения вирусов и улучшения для антивируса ClamAV. “daily.cvd” - база данных вирусных сигнатур, которая ежедневно обновляется.“main.cvd” - основная база данных вирусных сигнатур.
Формат .cvd использует это программа и некоторые другие специализированные, чтобы просмотреть содержимое баз данных нужно ввести команду: sudo sigtool -u FileName
В моем случае я скопировал файл “daily.cvd” в папку “clamavDB” на рабочем столе, поэтому нам нужно первым делом из консоли добраться до данной папки путем простой команды: cd Рабочий\ стол/clamavDB и ввести команду выше, а именно sudo sigtool -u daily.cvd. Тем самым мы получаем все файлы хранящиеся в “daily.cvd” в нашей папке “clamavDB”.

Рис. 8 Демонстрация полученных файлов.
Нас интересует файл “daily.mdb”, поэтому удаляем все файлы, кроме исходного “daily.cvd” и “daily.mdb”. Без специализированных программ мы не сможем прочитать интересующий нас файл, но мы можем конвертировать “daily.mdb” в “daily.xlsx” и уже его прочитать как файл офисной таблицы.

Рис.9 Демонстрация интересующих нас файлов.
Тем самым мы можем узнать какая сигнатура какому типу вирусов принадлежит.
